#!/usr/bin/env bash

set -ueo pipefail

# Configuration
DEFAULT_GROUPS='adm,cdrom,sudo,dip,plugdev'
DEFAULT_UID='1000'
MAX_ATTEMPTS=3

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to validate username
validate_username() {
    local username=$1
    
    # Check if username is empty
    if [[ -z "$username" ]]; then
        echo -e "${RED}Error: Username cannot be empty${NC}" >&2
        return 1
    fi
    
    # Check username length (1-32 characters)
    if [[ ${#username} -lt 1 || ${#username} -gt 32 ]]; then
        echo -e "${RED}Error: Username must be between 1 and 32 characters${NC}" >&2
        return 1
    fi
    
    # Check if username starts with a number
    if [[ "$username" =~ ^[0-9] ]]; then
        echo -e "${YELLOW}Warning: Usernames starting with numbers are not recommended${NC}" >&2
    fi
    
    # Check for invalid characters (only alphanumeric, underscores, and hyphens allowed)
    if [[ ! "$username" =~ ^[a-zA-Z0-9_][a-zA-Z0-9_-]*$ ]]; then
        echo -e "${RED}Error: Username contains invalid characters. Only letters, numbers, underscores, and hyphens are allowed.${NC}" >&2
        return 1
    fi
    
    # Check if username already exists
    if id -u "$username" &>/dev/null; then
        echo -e "${RED}Error: Username '$username' already exists${NC}" >&2
        return 1
    fi
    
    return 0
}

# Function to create user
create_user() {
    local username=$1
    
    echo -e "${GREEN}Creating user '$username'...${NC}"
    
    # Create the user with home directory and shell
    if ! /usr/sbin/adduser --uid "${DEFAULT_UID}" --quiet --gecos '' --disabled-password "${username}"; then
        echo -e "${RED}Failed to create user '$username'${NC}" >&2
        return 1
    fi
    
    # Set a random password (required by some applications)
    local password=$(< /dev/urandom tr -dc 'A-Za-z0-9' | head -c16)
    echo "${username}:${password}" | chpasswd
    
    # Add user to additional groups
    if ! /usr/sbin/usermod -aG "${DEFAULT_GROUPS}" "${username}"; then
        echo -e "${YELLOW}Warning: Failed to add user to additional groups${NC}" >&2
        # Continue even if group addition fails
    fi
    
    echo -e "${GREEN}User '$username' created successfully!${NC}"
    echo -e "${YELLOW}Note: A random password has been set. Use 'passwd' to change it.${NC}"
    return 0
}

# Main execution
main() {
    echo -e "${GREEN}=== ThreatOS WSL First-Run Setup ===${NC}\n"
    
    # Check if user already exists
    if getent passwd "$DEFAULT_UID" > /dev/null; then
        local existing_user=$(getent passwd "$DEFAULT_UID" | cut -d: -f1)
        echo -e "${GREEN}User '$existing_user' already exists. Setup complete.${NC}"
        exit 0
    fi
    
    echo 'Waiting for systemd to start...'
    if ! timeout 25 bash -c 'until systemctl is-system-running 2>/dev/null | grep -E "(running|degraded)" >/dev/null; do sleep 1; done'; then
        echo -e "${YELLOW}Warning: Timed out waiting for systemd to start${NC}"
        echo -e "${YELLOW}Continuing with user creation...${NC}"
    fi
    
    echo -e "\nPlease create a default ThreatOS WSL user."
    echo -e "The username does not need to match your Windows username."
    echo -e "For more information visit: ${YELLOW}https://aka.ms/wslusers${NC}\n"
    
    # Attempt to create user
    local attempts=0
    while [[ $attempts -lt $MAX_ATTEMPTS ]]; do
        read -p 'Enter new UNIX username: ' username
        
        if validate_username "$username"; then
            if create_user "$username"; then
                exit 0
            fi
        fi
        
        attempts=$((attempts + 1))
        remaining=$((MAX_ATTEMPTS - attempts))
        
        if [[ $remaining -gt 0 ]]; then
            echo -e "${YELLOW}Please try again. $remaining attempts remaining.${NC}"
        fi
    done
    
    echo -e "\n${RED}Failed to create user after $MAX_ATTEMPTS attempts.${NC}"
    echo -e "You can create a user manually by running 'adduser' after this setup.\n"
    exit 1
}

# Run main function
main "$@"
