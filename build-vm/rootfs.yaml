{{- $arch := .arch }}
{{- $branch := .branch }}
{{- $mirror := .mirror }}

{{- $desktop := .desktop }}
{{- $hostname := .hostname }}
{{- $keyboard := .keyboard }}
{{- $locale := .locale }}
{{- $packages := .packages }}
{{- $password := .password }}
{{- $timezone := .timezone }}
{{- $toolset := .toolset }}
{{- $username := .username }}

architecture: {{ $arch }}

actions:
  - action: debootstrap
    mirror: {{ $mirror }}
    suite: {{ $branch }}
    components: [ main, contrib, non-free, non-free-firmware ]
    keyring-file: /usr/share/keyrings/debian-archive-keyring.gpg

  - description: "Preseed package configuration"
    action: run
    chroot: true
    script: scripts/preseed.sh

  - description: "Install standard packages"
    action: run
    chroot: true
    script: scripts/install-standard-packages.sh

  - description: "Set default locale {{ $locale }}"
    action: run
    chroot: true
    script: scripts/setup-locale.sh {{ $locale }}

  - description: "Set default timezone {{ $timezone }}"
    action: run
    chroot: true
    script: scripts/setup-timezone.sh {{ $timezone }}

  - description: "Set hostname to {{ $hostname }}"
    action: run
    chroot: false
    command: echo {{ $hostname }} > $ROOTDIR/etc/hostname

  - description: "Install core and desktop selection: {{ $desktop }}"
    action: apt
    recommends: true
    packages:
      - debian-{{ $arch }}-linux-core
      - debian-{{ $arch }}-linux-firmware
{{ if ne $desktop "none" }}
      - debian-{{ $arch }}-desktop-{{ $desktop }}
{{ end }}

{{ if ne $toolset "none" }}
  - description: "Install tool selection: {{ $toolset }}"
    action: apt
    recommends: true
    packages:
      - debian-{{ $arch }}-linux-{{ $toolset }}
{{ end }}

{{ if ne $packages "" }}
  - description: "Install extra packages: {{ $packages }}"
    action: apt
    recommends: true
    packages: [ {{ $packages }} ]
{{ end }}

  - action: overlay
    source: overlays/loopback-interface

  - description: "Set default keyboard {{ $keyboard }}"
    action: run
    chroot: true
    script: scripts/setup-keyboard.sh {{ $keyboard }}

  - description: "Create user {{ $username }}"
    action: run
    chroot: true
    script: scripts/create-user.sh {{ $username }} "{{ $password }}"

  - description: "Finish installation"
    action: run
    chroot: true
    script: scripts/finish-install.sh debconf etc-hosts terminal usergroups zsh

  - description: "Final cleanup (from within)"
    action: run
    chroot: true
    script: scripts/cleanup-in.sh

  - description: "Final cleanup (from outside)"
    action: run
    chroot: false
    script: scripts/cleanup-out.sh
