#!/bin/bash
# ThreatOS Application Manager
# A framework for managing containerized applications on ThreatOS

set -euo pipefail

# Default configuration
CONFIG_DIR="/etc/threatos/apps"
LOG_DIR="/var/log/threatos/apps"
DATA_DIR="/var/lib/threatos/apps"
BIN_DIR="/usr/local/bin"
COMPOSE_CMD="docker-compose"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if running as root
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo -e "${RED}Error: This script must be run as root${NC}" >&2
        exit 1
    fi
}

# Check if Docker is installed
check_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}Error: Docker is not installed${NC}" >&2
        exit 1
    fi
    
    if ! command -v docker-compose &> /dev/null; then
        echo -e "${YELLOW}Warning: docker-compose not found, using docker compose plugin${NC}"
        COMPOSE_CMD="docker compose"
    fi
}

# Initialize the application manager
init() {
    echo -e "${GREEN}Initializing ThreatOS Application Manager...${NC}"
    
    # Create required directories
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$LOG_DIR"
    mkdir -p "$DATA_DIR"
    
    # Set proper permissions
    chmod 755 "$CONFIG_DIR"
    chmod 755 "$LOG_DIR"
    chmod 755 "$DATA_DIR"
    
    echo -e "${GREEN}ThreatOS Application Manager initialized successfully${NC}"
}

# Install an application
install_app() {
    local app_name="$1"
    local compose_file="${2:-docker-compose.yml}"
    
    echo -e "${GREEN}Installing application: ${app_name}${NC}"
    
    # Create app directory
    local app_dir="$CONFIG_DIR/$app_name"
    mkdir -p "$app_dir"
    
    # Copy compose file
    if [ ! -f "$compose_file" ]; then
        echo -e "${RED}Error: Compose file not found: $compose_file${NC}" >&2
        return 1
    fi
    
    cp "$compose_file" "$app_dir/docker-compose.yml"
    
    # Create data directory
    mkdir -p "$DATA_DIR/$app_name"
    
    # Create log directory
    mkdir -p "$LOG_DIR/$app_name"
    
    # Create wrapper script
    cat > "/usr/local/bin/threatos-${app_name}" << EOF
#!/bin/bash
# Wrapper script for ${app_name}

exec "$COMPOSE_CMD" -f "$app_dir/docker-compose.yml" -p "${app_name}" "\$@"
EOF
    
    chmod +x "/usr/local/bin/threatos-${app_name}"
    
    echo -e "${GREEN}Application '${app_name}' installed successfully${NC}"
    echo -e "Use 'threatos-${app_name} up -d' to start the application"
}

# Uninstall an application
uninstall_app() {
    local app_name="$1"
    local app_dir="$CONFIG_DIR/$app_name"
    
    if [ ! -d "$app_dir" ]; then
        echo -e "${RED}Error: Application '${app_name}' not found${NC}" >&2
        return 1
    fi
    
    echo -e "${YELLOW}Uninstalling application: ${app_name}${NC}"
    
    # Stop and remove containers
    if [ -f "/usr/local/bin/threatos-${app_name}" ]; then
        "/usr/local/bin/threatos-${app_name}" down
        rm -f "/usr/local/bin/threatos-${app_name}"
    fi
    
    # Remove app directory
    rm -rf "$app_dir"
    
    # Remove data and logs (with confirmation)
    echo -e "${YELLOW}The following directories will be removed:${NC}"
    echo "- $DATA_DIR/$app_name"
    echo "- $LOG_DIR/$app_name"
    read -p "Do you want to remove application data and logs? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$DATA_DIR/$app_name"
        rm -rf "$LOG_DIR/$app_name"
        echo -e "${GREEN}Application data and logs removed${NC}"
    fi
    
    echo -e "${GREEN}Application '${app_name}' uninstalled successfully${NC}"
}

# List installed applications
list_apps() {
    echo -e "${GREEN}Installed applications:${NC}"
    echo -e "${YELLOW}=======================${NC}"
    
    if [ -z "$(ls -A $CONFIG_DIR 2>/dev/null)" ]; then
        echo "No applications installed"
        return 0
    fi
    
    for app_dir in "$CONFIG_DIR"/*; do
        local app_name=$(basename "$app_dir")
        local status=$($COMPOSE_CMD -f "$app_dir/docker-compose.yml" ps --services --filter "status=running" 2>/dev/null | wc -l)
        
        if [ "$status" -gt 0 ]; then
            echo -e "${GREEN}✓ $app_name (running)${NC}"
        else
            echo -e "${RED}✗ $app_name (stopped)${NC}"
        fi
    done
}

# Show application status
app_status() {
    local app_name="$1"
    local app_dir="$CONFIG_DIR/$app_name"
    
    if [ ! -d "$app_dir" ]; then
        echo -e "${RED}Error: Application '${app_name}' not found${NC}" >&2
        return 1
    fi
    
    echo -e "${GREEN}Status of ${app_name}:${NC}"
    "$COMPOSE_CMD" -f "$app_dir/docker-compose.yml" ps
}

# Show help message
show_help() {
    cat << EOF
ThreatOS Application Manager - Manage containerized applications on ThreatOS

Usage: threatos-appmgr [COMMAND] [ARGS...]

Commands:
  init                    Initialize the application manager
  install APP_NAME [FILE] Install an application from a docker-compose file
  uninstall APP_NAME      Uninstall an application
  list                    List all installed applications
  status APP_NAME         Show status of an application
  help                    Show this help message

Examples:
  threatos-appmgr init
  threatos-appmgr install myapp /path/to/docker-compose.yml
  threatos-appmgr uninstall myapp
  threatos-appmgr list
  threatos-appmgr status myapp

For more information, visit https://threatos.org/docs/app-manager
EOF
}

# Main function
main() {
    check_root
    check_docker
    
    local command="${1:-help}"
    shift || true
    
    case "$command" in
        init)
            init
            ;;
        install)
            if [ $# -lt 1 ]; then
                echo -e "${RED}Error: Application name is required${NC}" >&2
                show_help
                exit 1
            fi
            install_app "$@"
            ;;
        uninstall)
            if [ $# -lt 1 ]; then
                echo -e "${RED}Error: Application name is required${NC}" >&2
                show_help
                exit 1
            fi
            uninstall_app "$1"
            ;;
        list)
            list_apps
            ;;
        status)
            if [ $# -lt 1 ]; then
                echo -e "${RED}Error: Application name is required${NC}" >&2
                show_help
                exit 1
            fi
            app_status "$1"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}Error: Unknown command: $command${NC}" >&2
            show_help
            exit 1
            ;;
    esac
}

# Run the main function
main "$@"
